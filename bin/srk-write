#!/usr/bin/env abs

stripeCards = [
    { "number": "4242 4242 4242 4242", "setup": true,   "pay": true,                 "sca": "" },
    { "number": "4000 0000 0000 0341", "setup": true,   "pay": false,                "sca": "" },
    { "number": "4000 0000 0000 9995", "setup": true,   "pay": "insufficient_funds", "sca": "" },
    { "number": "4000 0000 0000 9987", "setup": true,   "pay": "lost_card",          "sca": "" },
    { "number": "4000 0000 0000 9979", "setup": true,   "pay": "stolen_card",        "sca": "" },
    { "number": "4000 0027 6000 3184", "setup": true,   "pay": true,                 "sca": "Always" },
    { "number": "4000 0535 6000 0011", "setup": false,  "pay": false,                "sca": "" }
]

providers = {
    "stripe-card": f() {
        data = stripeCards.map(f(card){
            setup = card.setup && "✔️" || "❌"
            pay = type(card.pay) == "BOOLEAN"
                && (card.pay && "✔️" || "❌")
                || "❌ " + card.pay

            return [card.number, setup, pay, card.sca]
                .map(f(t){'"$t"'}).join(' ');
        }).join(" ")

        output = `
            zenity --list \
                --title="Stripe Card Picker" \
                --width="500" \
                --height="300" \
                --text="Pick a credit card" \
                --extra-button="More cards" \
                --column="Number" --column="Setup" --column="Pay" --column="SCA" \
                $data \
                || exit 0
        `
        if output == "More cards" {
            `xdg-open "https://stripe.com/docs/testing#cards"`
            exit(0)
        }
        return output.replace(" ", "")
    }
}

if args().len() > 2 {
    provider = arg(2)
    text = providers[provider]()
    `xdotool type --delay 100 "$text"`
}
